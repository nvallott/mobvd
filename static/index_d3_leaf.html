<!DOCTYPE html>
<html>

<head>
  <script src="https://maps.googleapis.com/maps/api/js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.min.js"></script>
  <script src="https://d3js.org/d3-contour.v1.min.js"></script>
  <script src="https://d3js.org/d3-hsv.v0.1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

  <style>
    #map {
      height: 600px;
      width: 600px;
    }

	#map img {
		margin:0px;
		padding:0px;
	}

  </style>

</head>

<body>
  <div id="map"></div>
  <script>
    var map = new google.maps.Map(d3.select("#map").node(), {
      zoom: 12,
      center: new google.maps.LatLng(51.5182904, -0.0868177),
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      styles: [
				{
					"featureType": "all",
					"elementType": "labels",
					"stylers": [
						{
							"visibility": "off"
						}
					]
				},
				{
					"featureType": "all",
					"elementType": "labels.text",
					"stylers": [
						{
							"visibility": "on"
						}
					]
				},
				{
					"featureType": "all",
					"elementType": "labels.text.fill",
					"stylers": [
						{
							"color": "#000000"
						}
					]
				},
				{
					"featureType": "all",
					"elementType": "labels.text.stroke",
					"stylers": [
						{
							"color": "#ffffff"
						}
					]
				},
				{
					"featureType": "all",
					"elementType": "labels.icon",
					"stylers": [
						{
							"visibility": "on"
						}
					]
				},
				{
					"featureType": "administrative",
					"elementType": "all",
					"stylers": [
						{
							"visibility": "off"
						}
					]
				},
				{
					"featureType": "landscape",
					"elementType": "all",
					"stylers": [
						{
							"color": "#ffffff"
						}
					]
				},
				{
					"featureType": "poi",
					"elementType": "all",
					"stylers": [
						{
							"visibility": "off"
						}
					]
				},
				{
					"featureType": "road",
					"elementType": "geometry.fill",
					"stylers": [
						{
							"color": "#000000"
						},
						{
							"weight": 1
						}
					]
				},
				{
					"featureType": "road",
					"elementType": "geometry.stroke",
					"stylers": [
						{
							"color": "#000000"
						},
						{
							"weight": 0.8
						}
					]
				},
				{
					"featureType": "road",
					"elementType": "labels",
					"stylers": [
						{
							"visibility": "on"
						}
					]
				},
				{
					"featureType": "transit",
					"elementType": "all",
					"stylers": [
						{
							"visibility": "off"
						}
					]
				},
				{
					"featureType": "water",
					"elementType": "all",
					"stylers": [
						{
							"visibility": "off"
						}
					]
				}
			]
    });


	d3.csv("grid_200m_drivetimes.csv", function(error, data) {

		if (error) throw error

		var overlay = new google.maps.OverlayView();

		overlay.onAdd = function() {

			var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")

			overlay.draw = function() {

				var overlayProjection = this.getProjection();

				layer.select('svg').remove();

				var n = 151, m = 151, values = new Array(n * m);

				var w = 600;
				var h = 600;

				format = d3.format(".2f")
				values = []
				data.forEach(function(d) {
					values.push(+format(d.duration))
				});

				var svg = layer.append("svg")
							   .attr('id', "container")
							   .attr('width', w)
							   .attr('height', h)


				var thresholds = d3.range(1, 21)
					.map(function(p) { return Math.pow(2, p); });

				var thresholds = [20,60,120,180,240,300,600,900,1200,1500,1800,2400,3000];

				console.log(values);
				var contours = d3.contours()
					.size([n, m])
					.thresholds(thresholds);

				var contour2Lat = d3.scaleLinear()
					.domain([1,151])
					.range([51.652911364266849, 51.383268265081114])

				var contour2Lng = d3.scaleLinear()
									.domain([1,151])
									.range([-0.30291580068372814, 0.13056075670794678])

				project = d3.geoTransform({point: function(x, y) {
						  d = new google.maps.LatLng(y, x);
						  d = overlayProjection.fromLatLngToDivPixel(d);
						  return this.stream.point(d.x, d.y);
						}
					  });

				var path = d3.geoPath().projection(project);

				var color = d3.scaleLog()
					.domain(d3.extent(thresholds))
					.interpolate(function() { return d3.interpolateYlGnBu; });

				svg.selectAll("path")
				  .data(contours(values).map(convert))
				  .enter().append("path")
					.attr("d", path)
					.attr("id", function(d, i) { return i; })
					.attr("fill", function(d) { return color(d.value); })
					.attr("opacity", 0.2)

				function convert(d) {
					var shared = {};

					var p = {
					  type: "Polygon",
					  coordinates: d3.merge(d.coordinates.map(function(polygon) {
						return polygon.map(function(ring) {
						  return ring.map(function(point) {
							return [
							  contour2Lng(point[0]),
							  contour2Lat(point[1])
							];
						  }).reverse();
						});
					  }))
					};

					p.value = d.value;
					return p;
				}
			}
		}
		overlay.set("Opacity", 0.2)
		overlay.setMap(map);
	});

  </script>
</body>

</html>
